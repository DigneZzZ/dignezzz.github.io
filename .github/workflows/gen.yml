name: Generate shadowrocket rules

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"  # Каждые 6 часов (достаточно для обновления списков)
  push:
    branches:
      - main
    paths:
      - 'shadowrocket/**'  # Запуск только при изменении shadowrocket файлов

concurrency:
  group: gen-rules
  cancel-in-progress: true

env:
  TZ: Europe/Moscow
  REPO_URL: https://raw.githubusercontent.com/${{ github.repository }}

jobs:
  build_and_publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ACCESS_TOKEN }}

      - name: Generate rule lists
        run: |
          mkdir -p rules
          
          # Domain custom list
          curl -sSLf --retry 3 --retry-delay 5 \
            "${{ env.REPO_URL }}/main/shadowrocket/custom.list" \
            | sed -E 's/^\+\./DOMAIN-SUFFIX,/; s/^[^D]/DOMAIN-SUFFIX,&/' \
            > rules/domain_custom.list
          
          # Domain antifilter list
          curl -sSLf --retry 3 --retry-delay 5 \
            "https://community.antifilter.download/list/domains.lst" \
            | sed -E 's/^\+\./DOMAIN-SUFFIX,/; s/^[^D]/DOMAIN-SUFFIX,&/' \
            > rules/domain_antifilter.list
          
          # GeoIP antifilter list
          curl -sSLf --retry 3 --retry-delay 5 \
            "https://community.antifilter.download/list/community.lst" \
            | sed 's/^/IP-CIDR,/' \
            > rules/geoip_antifilter.list

      - name: Build Shadowrocket config
        run: |
          cat shadowrocket/General.txt > rules/sr_ru_public_lists.conf
          
          cat >> rules/sr_ru_public_lists.conf << 'EOF'
          [Rule]
          RULE-SET,https://raw.githubusercontent.com/${{ github.repository }}/release/rules/domain_custom.list,PROXY
          RULE-SET,https://raw.githubusercontent.com/${{ github.repository }}/release/rules/domain_antifilter.list,PROXY
          RULE-SET,https://raw.githubusercontent.com/${{ github.repository }}/release/rules/geoip_antifilter.list,PROXY,no-resolve
          FINAL,DIRECT
          EOF
          
          sed -i "1s|^|# @DigneZzZ, built on $(date '+%Y-%m-%d %H:%M %Z')\n|" rules/sr_ru_public_lists.conf

      - name: Set release info
        run: |
          echo "RELEASE_NAME=Built on $(date '+%Y%m%d%H%M')" >> $GITHUB_ENV
          echo "TAG_NAME=$(date '+%Y%m%d%H%M')" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ env.RELEASE_NAME }}
          tag_name: ${{ env.TAG_NAME }}
          files: ./rules/*
        env:
          GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}

      - name: Push to release branch
        run: |
          cd rules
          git init
          git config user.name "${{ secrets.USER_NAME }}"
          git config user.email "${{ secrets.USER_EMAIL }}"
          git checkout -b release
          git add .
          git commit -m "${{ env.RELEASE_NAME }}"
          git remote add origin "https://${{ github.actor }}:${{ secrets.ACCESS_TOKEN }}@github.com/${{ github.repository }}"
          git push -f origin release

      - name: Purge jsDelivr CDN cache
        run: |
          for file in rules/*; do
            filename=$(basename "$file")
            curl -sS "https://purge.jsdelivr.net/gh/${{ github.repository }}@release/rules/${filename}" || true
          done

  cleanup:
    runs-on: ubuntu-latest
    needs: build_and_publish
    if: success()
    steps:
      - name: Delete old releases
        uses: dev-drprasad/delete-older-releases@v0.3.4
        with:
          keep_latest: 3
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}

      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.ACCESS_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 2
          keep_minimum_runs: 3
